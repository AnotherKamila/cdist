#!/usr/bin/env python3
#
# 2010-2011 Nico Schottelius (nico-cdist at schottelius.org)
#
# This file is part of cdist.
#
# cdist is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# cdist is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with cdist. If not, see <http://www.gnu.org/licenses/>.
#
#

import sys # argv
import subprocess # execute stuff

__cdist_version="2.0.0"

def logger(type, *args):
   """Ignore type for now, support later"""
   print(*args)

def exit_error(*args):
   logger(*args)
   sys.exit(1)
   

def run_or_fail(*args):
   newargs = ["echo"]
   newargs.extend(*args)

   try:
      subprocess.check_call(newargs)
   except CalledProcessError:
      exit_error("Command failed:", newargs)

def remote_run_or_fail(hostname, *args):
   newargs = ["ssh", hostname]
   newargs.extend(*args)

   run_or_fail(newargs)


def cdist_deploy_to(hostname):
   """Mimic the old deploy to: Deploy to one host"""
   logger("info", "Deploying to host", hostname)
   init_deploy(hostname)


def init_deploy(hostname):
   logger("info", "Creating clean directory structure")

   # Ensure there is no old stuff, neither local nor remote
   run_or_fail(["echo", "rm -rf", "$__cdist_local_base_dir"])

   remote_run_or_fail(hostname, ["rm -rf", "${__cdist_remote_base_dir}"])
#
#   # Init base
#   mkdir -p "$__cdist_local_base_dir"
#   ssh "${__cdist_remote_user}@${__cdist_target_host}" \
#      "mkdir -p ${__cdist_remote_base_dir}"
#
#   # Link configuraion source directory - consistent with remote
#   ln -sf "$__cdist_conf_dir" "$__cdist_local_base_dir/$__cdist_name_conf_dir"


if __name__ == "__main__":
   hostname=sys.argv[1]
   logger("info", "cdist", __cdist_version, ": Configuring host", hostname)
   cdist_deploy_to(hostname)

