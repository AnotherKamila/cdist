#!/bin/sh
#
# 2011 Nico Schottelius (nico-cdist at schottelius.org)
# 2011 Steven Armstrong (steven-cdist at armstrong.cc)
#
# This file is part of cdist.
#
# cdist is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# cdist is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with cdist. If not, see <http://www.gnu.org/licenses/>.
#
# 
# Run cdist-object-run for each created object.
#

. cdist-config
[ $# -eq 1 ] || __cdist_usage "<target host>"
set -eu

__cdist_target_host="$1"; shift

__cdist_objects="$__cdist_tmp_dir/objects"

FIXME: reuse in subscripts, save in objects_base_dir
export __cdist_objects_created="$__cdist_tmp_dir/objects_created"

# Loop until we do not create new objects anymore
# which is equal to all objects have been run
touch "$__cdist_new_objects_created"
while [ -f "$__cdist_new_objects_created" ]; do
   # Assume we're done after this run
   rm "$__cdist_new_objects_created"

   # Get listing of objects
   __cdist_object_list "$__cdist_out_object_dir" > "$__cdist_objects"

   # NEED TO CREATE ARRAY, SSH DESTROYS WHILE READ LOOP
   while read __cdist_object; do
      set -- "$@" "$__cdist_object"
   done < "$__cdist_objects"

   while [ $# -gt 0 ]; do
      __cdist_object="$1"; shift

      FIXME: migrate into cdist-object-run
      FIXME: take care of SSH foo after migration in while loop
      __cdist_object_require="$(__cdist_object_require "$__cdist_object")"
      if [ -f "$__cdist_object_require" ]; then
         echo 
         while read __cdist_requirement; do
            echo "Resolving dependency $__cdist_requirement for $__cdist_object  ..."
            cdist-object-run "$__cdist_target_host" "$__cdist_requirement"
         done < "$__cdist_object_require"
      fi

      # Process the object
      cdist-object-run "$__cdist_target_host" "$__cdist_object"
   done
done
