#!/bin/sh
#
# 2010-2011 Nico Schottelius (nico-cdist at schottelius.org)
#
# This file is part of cdist.
#
# cdist is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# cdist is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with cdist. If not, see <http://www.gnu.org/licenses/>.
#
# 
# Wrapper script that generates cconfig from arguments
#
# This script will be called everytime the manifest decides to create
# a new type
#

. cdist-config

[ $# -ge 1 ] || __cdist_usage "<id> <options>"

set -eu

echo "I am $__cdist_myname and have been called with $@"

export __cdist_object_id="$1"; shift
export __cdist_type_current="$__cdist_myname"

echo "$__cdist_object_id" | grep -q "^${__cdist_sane_regexp}\$" || __cdist_usage "Provide sane id, please"

__cdist_tid="${__cdist_myname}/${__cdist_object_id}"
__cdist_ddir="$(__cdist_cache_host)/${__cdist_name_object}/${__cdist_tid}"

if [ -e "${__cdist_ddir}" ]; then
   source="$(cat "${__cdist_ddir}/${__cdist_object_source}")"
   __cdist_usage "${__cdist_tid} already exists (source: $source)"
fi

mkdir -p "${__cdist_ddir}"

# Record (correct ;-) source
echo "${__cdist_manifest}" > "${__cdist_ddir}/${__cdist_object_source}"

while [ $# -gt 0 ]; do
   opt="$1"; shift

   echo "$opt" | grep -q "^--${__cdist_sane_regexp}\$" || __cdist_usage "Provide sane options"

   opt_file="$(echo $opt | sed 's/^--//')"

   # FIXME: check for options supported by type - or leave it to the type?
   # I guess do it here, so we also check whether

   [ $# -ge 1 ] || __cdist_usage "Missing value for $opt"

   value="$1"; shift

   echo "${value}" > "${__cdist_ddir}/${opt_file}"

done
